<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Needs Board · Research Consortium Platform</title>
  <meta name="description" content="A forum-like board for posting and browsing collaboration needs." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#111522;
      --panel2:#0f1320;
      --text:#e9ecf2;
      --muted:#aab2c0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);

      --brand1:#7c3aed;
      --brand2:#22d3ee;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;

      --max: 1140px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(124,58,237,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(34,211,238,.14), transparent 55%),
        radial-gradient(700px 500px at 50% 95%, rgba(124,58,237,.10), transparent 55%),
        var(--bg);
      color: var(--text);
      line-height:1.6;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ width:min(var(--max), calc(100% - 40px)); margin:0 auto; }

    /* Topbar (consistent) */
    .topbar{
      position: sticky;
      top:0;
      z-index:10;
      background: rgba(11,13,18,.55);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar__inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 14px 0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .brand__mark{
      width: 14px;
      height: 14px;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      box-shadow: 0 0 0 4px rgba(124,58,237,.15);
    }
    .brand__name{
      font-weight:700;
      letter-spacing:.2px;
      font-size: .98rem;
      white-space:nowrap;
    }
    .nav{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }
    .nav a{
      color: var(--muted);
      font-weight:600;
      font-size:.92rem;
      padding:8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: .18s ease;
    }
    .nav a:hover{
      color: var(--text);
      background: rgba(255,255,255,.04);
      border-color: var(--line);
    }
    .nav a.active{
      color: var(--text);
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.18);
    }
    .topbar__cta{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      min-width: 240px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      height: 38px;
      padding: 0 14px;
      border-radius: 12px;
      font-weight:700;
      font-size:.92rem;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      transition:.18s ease;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.24);
      background: rgba(255,255,255,.05);
    }
    .btn--primary{
      border: 0;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.95));
      color:#071018;
      box-shadow: 0 18px 45px rgba(124,58,237,.22);
    }
    .btn--primary:hover{ filter:saturate(1.05); }
    .btn--danger{
      border-color: rgba(255,80,120,.35);
      background: rgba(255,80,120,.08);
    }

    /* Page header */
    .pageHead{
      padding: 28px 0 12px;
    }
    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size: 1.9rem;
      letter-spacing:-.4px;
      line-height:1.15;
    }
    .sub{
      margin:8px 0 0;
      color: var(--muted);
      max-width: 90ch;
      font-size: .98rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      font-weight:700;
      font-size:.82rem;
      background: rgba(255,255,255,.03);
    }
    .pill .dot{
      width:8px; height:8px; border-radius:999px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      box-shadow: 0 0 0 3px rgba(34,211,238,.12);
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 16px;
      align-items:start;
      padding-bottom: 44px;
    }

    /* Panel */
    .panel{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(17,21,34,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .inner{ padding: 16px; }
    .panelHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead b{ letter-spacing:.1px; }

    /* Form */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      display:block;
      color: var(--muted);
      font-weight:700;
      font-size:.85rem;
      margin: 12px 0 6px;
    }
    input[type="text"], input[type="email"], input[type="url"], textarea, select{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 12px;
      font-size: .92rem;
      outline: none;
    }
    textarea{ min-height: 86px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(34,211,238,.35);
      box-shadow: 0 0 0 4px rgba(34,211,238,.10);
    }
    .help{
      margin-top: 8px;
      color: var(--muted);
      font-size: .88rem;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .82rem;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
    }
    .checklist{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: .9rem;
    }
    .checklist li{ margin: 6px 0; }

    .coverRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top: 8px;
      flex-wrap:wrap;
    }
    .coverPreview{
      width: 92px;
      height: 64px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-size:.82rem;
    }
    .coverPreview img{ width:100%; height:100%; object-fit:cover; display:block; }

    .formActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }

    /* Board controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .controls input[type="text"]{ min-width: 240px; }
    .mini{
      height: 36px;
      padding: 0 12px;
      border-radius: 12px;
      font-size: .9rem;
    }

    /* Cards grid */
    .feed{
      padding: 16px;
    }
    .masonry{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .post{
      grid-column: span 4;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(17,21,34,.45);
      overflow:hidden;
      transition: .18s ease;
      position:relative;
    }
    .post:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.22);
      background: rgba(17,21,34,.60);
    }
    .postCover{
      height: 138px;
      background:
        radial-gradient(520px 220px at 10% 0%, rgba(124,58,237,.20), transparent 60%),
        radial-gradient(520px 220px at 90% 0%, rgba(34,211,238,.16), transparent 60%),
        rgba(255,255,255,.02);
      border-bottom: 1px solid rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .postCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .postBody{ padding: 12px 12px 12px; }
    .postTitle{
      margin: 0 0 6px;
      font-size: 1.02rem;
      letter-spacing: -.1px;
      line-height:1.25;
    }
    .postOutcome{
      margin:0 0 10px;
      color: rgba(255,255,255,.86);
      font-weight:600;
      font-size:.92rem;
    }
    .postMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:.86rem;
      margin-top: 10px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 4px 8px;
      font-weight:700;
    }
    .postFooter{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size:.86rem;
    }
    .linkish{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      color: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
    }
    .arrow{
      width: 18px; height: 18px;
      display:inline-block;
      border-radius: 7px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      text-align:center;
      line-height: 18px;
      font-size: 12px;
      transform: translateY(-1px);
    }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 50;
    }
    .modal{
      width: min(860px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(17,21,34,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .modalTop b{ font-size:.95rem; }
    .modalClose{ cursor:pointer; }
    .modalBody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      padding: 14px;
    }
    .modalCover{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      min-height: 220px;
      background: rgba(255,255,255,.03);
    }
    .modalCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .modalTxt{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .kv{
      margin: 0 0 10px;
      font-size:.92rem;
      color: var(--muted);
    }
    .kv b{ color: var(--text); }
    .mono{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .88rem;
      color: rgba(255,255,255,.88);
      line-height:1.45;
    }

    /* Responsive */
    @media (max-width: 1040px){
      .layout{ grid-template-columns: 1fr; }
      .post{ grid-column: span 6; }
    }
    @media (max-width: 720px){
      .post{ grid-column: span 12; }
      .modalBody{ grid-template-columns: 1fr; }
      .controls input[type="text"]{ min-width: 0; width:100%; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="wrap topbar__inner">
      <a class="brand" href="./contact.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true"></span>
        <span class="brand__name">Research Consortium Platform</span>
      </a>

      <nav class="nav" aria-label="Primary navigation">
        <a class="active" href="./needs-board.html">Needs</a>
        <a href="./capabilities.html">Capabilities</a>
        <a href="./collaboration.html">Collaboration</a>
        <a href="./governance.html">Governance</a>
      </nav>

      <div class="topbar__cta">
        <a class="btn" href="#post">Post</a>
        <a class="btn btn--primary" href="#browse">Browse</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="pageHead">
      <div class="titleRow">
        <div>
          <div class="pill"><span class="dot" aria-hidden="true"></span> Forum-like board (Step 2.1 · static demo)</div>
          <h1>Needs Board</h1>
          <p class="sub">
            Post collaboration needs in a structured way, then browse them as a card feed.
            In Step 2.2 we’ll connect this to a real backend so everyone sees the same board.
          </p>
        </div>
        <div class="controls" id="browse">
          <input id="q" type="text" placeholder="Search title / tags / context…" />
          <select id="tagFilter" class="mini" title="Filter by tag">
            <option value="">All tags</option>
          </select>
          <select id="sortBy" class="mini" title="Sort">
            <option value="new">Newest</option>
            <option value="old">Oldest</option>
            <option value="az">Title A→Z</option>
          </select>
          <button class="btn mini" id="seedBtn" type="button">Add sample</button>
        </div>
      </div>
    </section>

    <section class="layout" id="post">
      <!-- Left: Post form -->
      <div class="panel">
        <div class="panelHead">
          <b>Post a Need</b>
          <span style="color:var(--muted); font-weight:700; font-size:.86rem;">Saved locally (Step 2.1)</span>
        </div>
        <div class="inner">
          <div class="help">
            把信息写得像“可执行任务”，就会更容易匹配到人：<span class="kbd">输入</span> / <span class="kbd">输出</span> / <span class="kbd">验收标准</span>
          </div>
          <ol class="checklist">
            <li>一句话标题 + 明确结果</li>
            <li>写清输入 / 输出 / 验收标准</li>
            <li>写清可用时间窗口与响应方式</li>
            <li>写清你能提供什么（署名/经费/资源）</li>
          </ol>

          <label>1) Title (one sentence)</label>
          <input id="f_title" type="text" placeholder='e.g., Need: EEG dataset for SSVEP benchmark (500+ subjects)' />

          <label>Outcome / Deliverable</label>
          <input id="f_outcome" type="text" placeholder="What does success look like? (metric / deliverable)" />

          <div class="grid2">
            <div>
              <label>Deadline (optional)</label>
              <input id="f_deadline" type="text" placeholder="e.g., 2026-03-15 or '2 weeks'" />
            </div>
            <div>
              <label>Availability / Response</label>
              <input id="f_window" type="text" placeholder="e.g., weekdays UTC+8 / reply in 48h" />
            </div>
          </div>

          <label>2) Context (1–2 paragraphs)</label>
          <textarea id="f_context" placeholder="What project & why now? current status (pilot/IRB/prototype), constraints…"></textarea>

          <label>3) What you need (inputs)</label>
          <textarea id="f_need" placeholder="Data / tool / facility / participants / expertise…"></textarea>

          <label>4) What you offer (outputs / resources)</label>
          <textarea id="f_offer" placeholder="Authorship/ack, funding/compute/lab time, co-dev support…"></textarea>

          <div class="grid2">
            <div>
              <label>Tags (comma separated)</label>
              <input id="f_tags" type="text" placeholder="e.g., EEG, SSVEP, dataset, hardware" />
            </div>
            <div>
              <label>Contact (email / link)</label>
              <input id="f_contact" type="text" placeholder="e.g., name@email.com or https://…" />
            </div>
          </div>

          <label>Cover image (optional)</label>
          <div class="coverRow">
            <div class="coverPreview" id="coverPreview">No cover</div>
            <input id="f_cover" type="file" accept="image/*" />
            <button class="btn mini" type="button" id="clearCover">Clear</button>
          </div>
          <div class="help">建议比例 16:9 或 4:3。Step 2.1 会把图片压缩后存到浏览器本地。</div>

          <div class="formActions">
            <button class="btn btn--primary" id="publish" type="button">Publish to board</button>
            <button class="btn" id="reset" type="button">Reset</button>
            <button class="btn btn--danger" id="clearAll" type="button">Clear all local posts</button>
          </div>
        </div>
      </div>

      <!-- Right: Feed -->
      <div class="panel">
        <div class="panelHead">
          <b>Board feed</b>
          <span id="count" style="color:var(--muted); font-weight:700; font-size:.86rem;">0 posts</span>
        </div>
        <div class="feed">
          <div class="masonry" id="list"></div>
          <div id="empty" style="display:none; margin-top:10px; color:var(--muted); font-weight:700;">
            No posts yet. Use the form on the left to publish your first Need.
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Post details">
      <div class="modalTop">
        <b id="m_title">Post</b>
        <div style="display:flex; gap:10px; align-items:center;">
          <span id="m_time" style="color:var(--muted); font-weight:700; font-size:.86rem;"></span>
          <span class="btn mini modalClose" id="m_close">Close</span>
        </div>
      </div>
      <div class="modalBody">
        <div class="modalCover" id="m_cover"></div>
        <div class="modalTxt">
          <p class="kv"><b>Outcome:</b> <span id="m_outcome"></span></p>
          <p class="kv"><b>Deadline:</b> <span id="m_deadline"></span></p>
          <p class="kv"><b>Availability:</b> <span id="m_window"></span></p>
          <p class="kv"><b>Tags:</b> <span id="m_tags"></span></p>
          <p class="kv"><b>Contact:</b> <span id="m_contact"></span></p>
          <hr style="border:0; border-top:1px solid rgba(255,255,255,.10); margin:12px 0;">
          <p class="kv"><b>Context</b></p>
          <div class="mono" id="m_context"></div>
          <p class="kv" style="margin-top:12px;"><b>What you need</b></p>
          <div class="mono" id="m_need"></div>
          <p class="kv" style="margin-top:12px;"><b>What you offer</b></p>
          <div class="mono" id="m_offer"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // --- Step 2.1 storage key (local only) ---
  const KEY = "rcp_needs_board_v1";

  // Elements
  const el = (id) => document.getElementById(id);
  const listEl = el("list");
  const emptyEl = el("empty");
  const countEl = el("count");
  const qEl = el("q");
  const tagFilterEl = el("tagFilter");
  const sortByEl = el("sortBy");

  // Form fields
  const f = {
    title: el("f_title"),
    outcome: el("f_outcome"),
    deadline: el("f_deadline"),
    window: el("f_window"),
    context: el("f_context"),
    need: el("f_need"),
    offer: el("f_offer"),
    tags: el("f_tags"),
    contact: el("f_contact"),
    cover: el("f_cover"),
    coverPreview: el("coverPreview"),
    clearCover: el("clearCover"),
  };

  let coverDataUrl = "";

  function nowISO(){
    return new Date().toISOString();
  }

  function load(){
    try{
      return JSON.parse(localStorage.getItem(KEY) || "[]");
    }catch(e){
      return [];
    }
  }

  function save(posts){
    localStorage.setItem(KEY, JSON.stringify(posts));
  }

  function uid(){
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function normalizeTags(s){
    return (s || "")
      .split(",")
      .map(t => t.trim())
      .filter(Boolean)
      .slice(0, 10);
  }

  function setCoverPreview(dataUrl){
    coverDataUrl = dataUrl || "";
    if(!coverDataUrl){
      f.coverPreview.innerHTML = "No cover";
      return;
    }
    f.coverPreview.innerHTML = "";
    const img = document.createElement("img");
    img.src = coverDataUrl;
    img.alt = "Cover preview";
    f.coverPreview.appendChild(img);
  }

  // Basic image compression to keep localStorage from exploding
  function compressImage(file, maxW=1200, quality=0.82){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(1, maxW / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);

          const canvas = document.createElement("canvas");
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const out = canvas.toDataURL("image/jpeg", quality);
          resolve(out);
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  f.cover.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file){ return; }
    try{
      const dataUrl = await compressImage(file);
      setCoverPreview(dataUrl);
    }catch(err){
      alert("Image load failed. Try another image.");
      setCoverPreview("");
    }
  });

  f.clearCover.addEventListener("click", () => {
    f.cover.value = "";
    setCoverPreview("");
  });

  function validate(){
    if(!f.title.value.trim()) return "Title is required.";
    if(!f.outcome.value.trim()) return "Outcome / deliverable is required.";
    if(!f.context.value.trim()) return "Context is required.";
    if(!f.need.value.trim()) return "What you need is required.";
    if(!f.offer.value.trim()) return "What you offer is required.";
    return "";
  }

  function publish(){
    const msg = validate();
    if(msg){ alert(msg); return; }

    const posts = load();
    const post = {
      id: uid(),
      createdAt: nowISO(),
      title: f.title.value.trim(),
      outcome: f.outcome.value.trim(),
      deadline: f.deadline.value.trim(),
      window: f.window.value.trim(),
      context: f.context.value.trim(),
      need: f.need.value.trim(),
      offer: f.offer.value.trim(),
      tags: normalizeTags(f.tags.value),
      contact: f.contact.value.trim(),
      cover: coverDataUrl,
    };
    posts.unshift(post);
    save(posts);
    resetForm(false);
    render();
    // jump to browse area on mobile
    document.getElementById("browse").scrollIntoView({behavior:"smooth", block:"start"});
  }

  function resetForm(clearCoverAlso=true){
    f.title.value = "";
    f.outcome.value = "";
    f.deadline.value = "";
    f.window.value = "";
    f.context.value = "";
    f.need.value = "";
    f.offer.value = "";
    f.tags.value = "";
    f.contact.value = "";
    if(clearCoverAlso){
      f.cover.value = "";
      setCoverPreview("");
    }
  }

  function clearAll(){
    if(!confirm("Clear ALL local posts on this browser?")) return;
    save([]);
    render();
  }

  function formatTime(iso){
    const d = new Date(iso);
    return d.toLocaleString();
  }

  function matches(post, q){
    if(!q) return true;
    const hay = [
      post.title, post.outcome, post.context, post.need, post.offer,
      (post.tags || []).join(" "),
      post.contact
    ].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function renderTagOptions(posts){
    const tags = new Set();
    posts.forEach(p => (p.tags||[]).forEach(t => tags.add(t)));
    const current = tagFilterEl.value || "";
    tagFilterEl.innerHTML = '<option value="">All tags</option>';
    Array.from(tags).sort((a,b)=>a.localeCompare(b)).forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      tagFilterEl.appendChild(opt);
    });
    // restore
    if(current && Array.from(tags).includes(current)){
      tagFilterEl.value = current;
    }
  }

  function card(post){
    const div = document.createElement("div");
    div.className = "post";

    const cover = document.createElement("div");
    cover.className = "postCover";
    if(post.cover){
      const img = document.createElement("img");
      img.src = post.cover;
      img.alt = "Cover";
      cover.appendChild(img);
    }
    div.appendChild(cover);

    const body = document.createElement("div");
    body.className = "postBody";

    const h = document.createElement("h3");
    h.className = "postTitle";
    h.textContent = post.title;
    body.appendChild(h);

    const out = document.createElement("p");
    out.className = "postOutcome";
    out.textContent = post.outcome;
    body.appendChild(out);

    const meta = document.createElement("div");
    meta.className = "postMeta";
    const chips = [];
    if(post.deadline) chips.push("Deadline: " + post.deadline);
    if(post.window) chips.push("Avail: " + post.window);
    (post.tags||[]).slice(0,3).forEach(t => chips.push("#"+t));
    chips.slice(0,4).forEach(c=>{
      const s = document.createElement("span");
      s.className = "chip";
      s.textContent = c;
      meta.appendChild(s);
    });
    body.appendChild(meta);

    div.appendChild(body);

    const footer = document.createElement("div");
    footer.className = "postFooter";

    const left = document.createElement("span");
    left.textContent = formatTime(post.createdAt);

    const right = document.createElement("span");
    right.className = "linkish";
    right.innerHTML = 'View <span class="arrow" aria-hidden="true">→</span>';
    right.addEventListener("click", () => openModal(post));

    footer.appendChild(left);
    footer.appendChild(right);

    div.appendChild(footer);

    return div;
  }

  function openModal(post){
    el("m_title").textContent = post.title;
    el("m_time").textContent = formatTime(post.createdAt);
    el("m_outcome").textContent = post.outcome || "";
    el("m_deadline").textContent = post.deadline || "—";
    el("m_window").textContent = post.window || "—";
    el("m_tags").textContent = (post.tags||[]).length ? (post.tags||[]).join(", ") : "—";
    el("m_contact").textContent = post.contact || "—";

    el("m_context").textContent = post.context || "";
    el("m_need").textContent = post.need || "";
    el("m_offer").textContent = post.offer || "";

    const coverBox = el("m_cover");
    coverBox.innerHTML = "";
    if(post.cover){
      const img = document.createElement("img");
      img.src = post.cover;
      img.alt = "Cover";
      coverBox.appendChild(img);
    }else{
      coverBox.style.display = "flex";
      coverBox.style.alignItems = "center";
      coverBox.style.justifyContent = "center";
      coverBox.style.color = "var(--muted)";
      coverBox.style.fontWeight = "800";
      coverBox.textContent = "No cover image";
    }

    const back = el("modalBack");
    back.style.display = "flex";
    back.setAttribute("aria-hidden", "false");

    // add delete button (local ownership not tracked; still useful for your own browser)
    const top = back.querySelector(".modalTop");
    let del = document.getElementById("m_del");
    if(!del){
      del = document.createElement("span");
      del.id = "m_del";
      del.className = "btn mini btn--danger";
      del.textContent = "Delete (local)";
      top.querySelector("div").insertBefore(del, top.querySelector("div").firstChild);
    }
    del.onclick = () => {
      if(!confirm("Delete this post from THIS browser?")) return;
      const posts = load().filter(p => p.id !== post.id);
      save(posts);
      closeModal();
      render();
    };
  }

  function closeModal(){
    const back = el("modalBack");
    back.style.display = "none";
    back.setAttribute("aria-hidden", "true");
  }

  el("m_close").addEventListener("click", closeModal);
  el("modalBack").addEventListener("click", (e) => {
    if(e.target === el("modalBack")) closeModal();
  });

  function render(){
    let posts = load();

    // controls
    renderTagOptions(posts);

    // filter
    const q = qEl.value.trim();
    const tag = tagFilterEl.value;
    posts = posts.filter(p => matches(p, q));
    if(tag){
      posts = posts.filter(p => (p.tags || []).includes(tag));
    }

    // sort
    const s = sortByEl.value;
    if(s === "old"){
      posts = posts.slice().sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
    }else if(s === "az"){
      posts = posts.slice().sort((a,b)=> (a.title||"").localeCompare(b.title||""));
    }else{
      posts = posts.slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    }

    // render
    listEl.innerHTML = "";
    posts.forEach(p => listEl.appendChild(card(p)));
    emptyEl.style.display = posts.length ? "none" : "block";
    countEl.textContent = posts.length + " posts";
  }

  // Events
  el("publish").addEventListener("click", publish);
  el("reset").addEventListener("click", () => resetForm(true));
  el("clearAll").addEventListener("click", clearAll);

  qEl.addEventListener("input", render);
  tagFilterEl.addEventListener("change", render);
  sortByEl.addEventListener("change", render);

  el("seedBtn").addEventListener("click", () => {
    const posts = load();
    posts.unshift({
      id: uid(),
      createdAt: nowISO(),
      title: "Need: EEG dataset for SSVEP benchmark (500+ subjects)",
      outcome: "Deliverable: reproducible benchmark set + baseline model results",
      deadline: "2026-03-15",
      window: "Reply in 48h, UTC+8 afternoons",
      context: "We’re building a cross-lab SSVEP benchmarking suite. Current status: pilot dataset (n=40). Need a larger dataset or partners with access.\nConstraints: device type, sampling rate, and subject metadata availability.",
      need: "- Dataset access (EEG SSVEP)\n- Advice on IRB/data sharing\n- Validation / baseline pipelines",
      offer: "- Authorship / acknowledgement\n- Compute credits + co-dev support\n- Shared benchmarking code + docs",
      tags: ["EEG","SSVEP","dataset","benchmark"],
      contact: "zhouzixuan602@gmail.com",
      cover: "",
    });
    save(posts);
    render();
  });

  // Init
  setCoverPreview("");
  render();
</script>
</body>
</html>
